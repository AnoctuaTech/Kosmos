<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kosmos Admin - Editor de Reglas</title>
    <link rel="stylesheet" href="../styles-kosmos.css">
    <style>
        /* --- Layout shell --- */
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: var(--bg-gray);
        }

        /* --- Top bar (title + actions) --- */
        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 32px;
            background: var(--bg-white);
            border-bottom: 1px solid var(--border-light);
        }
        .topbar-title {
            font-size: 22px;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.3;
        }
        .topbar-actions {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .topbar-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: var(--radius);
            color: var(--text-secondary);
            font-size: 20px;
            transition: background 0.15s, color 0.15s;
        }
        .topbar-icon:hover {
            background: var(--bg-gray);
            color: var(--text-primary);
        }
        .topbar-icon.icon-dots {
            font-size: 24px;
            letter-spacing: 1px;
        }
        .topbar-icon.icon-close svg {
            width: 20px;
            height: 20px;
        }

        /* --- Tab bar --- */
        .tabs-header {
            display: flex;
            align-items: center;
            gap: 4px;
            background: var(--bg-white);
            border-bottom: 1px solid var(--border);
            padding: 0 32px;
        }
        .tab-link {
            padding: 14px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s;
            text-decoration: none;
            white-space: nowrap;
        }
        .tab-link:hover {
            color: var(--text-primary);
        }
        .tab-pill-active {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 7px 18px;
            font-size: 14px;
            font-weight: 500;
            color: #fff;
            background: var(--primary);
            border-radius: 20px;
            cursor: default;
            margin: 8px 0;
        }

        /* --- Main content area (two-panel) --- */
        .editor-body {
            flex: 1;
            display: flex;
            gap: 24px;
            padding: 24px 32px;
            overflow-y: auto;
            align-items: flex-start;
        }

        /* --- Left panel: question summary --- */
        .panel-questions {
            flex: 3;
            min-width: 0;
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            padding: 24px 28px;
        }
        .panel-questions-header {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.8px;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-bottom: 20px;
        }

        /* Accordion question items */
        .q-item {
            border-bottom: 1px solid var(--border-light);
        }
        .q-item:last-child {
            border-bottom: none;
        }
        .q-item-header {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 14px 0;
            cursor: pointer;
            user-select: none;
        }
        .q-item-header:hover {
            opacity: 0.85;
        }
        .q-icon {
            flex-shrink: 0;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 16px;
            margin-top: 1px;
        }
        .q-icon svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }
        .q-text {
            flex: 1;
            font-size: 14px;
            color: var(--text-primary);
            line-height: 1.5;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .q-text.truncated {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .q-chevron {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            transition: transform 0.2s;
            margin-top: 2px;
        }
        .q-chevron svg {
            width: 16px;
            height: 16px;
        }
        .q-item.open .q-chevron {
            transform: rotate(180deg);
        }
        .q-item-body {
            display: none;
            padding: 0 0 14px 32px;
        }
        .q-item.open .q-item-body {
            display: block;
        }
        .q-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 0;
            font-size: 14px;
            color: var(--text-primary);
        }
        .q-option-radio {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid var(--border);
            flex-shrink: 0;
        }
        .q-option-check {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 2px solid var(--border);
            flex-shrink: 0;
        }

        /* --- Right panel: rules --- */
        .panel-rules {
            flex: 2;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Individual rule card */
        .rule-card {
            background: var(--bg-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            padding: 24px 28px;
        }
        .rule-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .rule-card-title {
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 0.5px;
            color: var(--text-primary);
            text-transform: uppercase;
        }
        .rule-card-actions {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .rule-icon-btn {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: var(--radius-sm);
            color: var(--text-muted);
            transition: background 0.15s, color 0.15s;
        }
        .rule-icon-btn:hover {
            background: var(--bg-gray);
            color: var(--text-primary);
        }
        .rule-icon-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Rule form rows */
        .rule-row {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 14px;
        }
        .rule-row:last-child {
            margin-bottom: 0;
        }
        .rule-label {
            width: 140px;
            flex-shrink: 0;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }
        .rule-field {
            flex: 1;
            min-width: 0;
        }
        .rule-select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            color: var(--text-primary);
            background: var(--bg-white);
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 32px;
        }
        .rule-select:focus {
            outline: none;
            border-color: var(--primary);
        }
        .rule-select option[value=""][disabled] {
            color: var(--text-muted);
        }
        .rule-input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            color: var(--text-primary);
            background: var(--bg-white);
        }
        .rule-input:focus {
            outline: none;
            border-color: var(--primary);
        }
        .rule-input::placeholder {
            color: var(--text-muted);
        }

        /* Placeholder / muted value in select */
        .rule-select.placeholder {
            color: var(--text-muted);
        }

        /* --- Footer bar --- */
        .footer-bar {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 20px;
            padding: 16px 32px;
            background: var(--bg-white);
            border-top: 1px solid var(--border);
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        .footer-add-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            background: none;
            border: none;
            cursor: pointer;
            border-radius: var(--radius);
            transition: background 0.15s;
        }
        .footer-add-btn:hover {
            background: var(--bg-gray);
        }
        .footer-save-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            color: #fff;
            background: var(--primary);
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: background 0.15s;
            text-decoration: none;
        }
        .footer-save-btn:hover {
            background: var(--primary-dark);
        }
        .footer-save-btn svg {
            width: 16px;
            height: 16px;
        }

        /* --- Dynamic rule fields (shown via JS) --- */
        .rule-fields-dynamic {
            display: none;
        }
        .rule-fields-dynamic.visible {
            display: block;
        }
    </style>
</head>
<body>

    <!-- ===== TOP BAR ===== -->
    <div class="topbar">
        <div class="topbar-title">Este es el titulo del estudio</div>
        <div class="topbar-actions">
            <button class="topbar-icon icon-dots" title="Mas opciones">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="5" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="19" r="1.5"/></svg>
            </button>
            <a href="01-Lista-Plantillas.html" class="topbar-icon icon-close" title="Cerrar">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </a>
        </div>
    </div>

    <!-- ===== TAB BAR ===== -->
    <div class="tabs-header">
        <a href="02-Editor-Preguntas.html" class="tab-link">Agregar preguntas</a>
        <span class="tab-pill-active">Reglas</span>
        <a href="04-Editor-Config.html" class="tab-link">Configuracion general</a>
    </div>

    <!-- ===== MAIN CONTENT (two-panel) ===== -->
    <div class="editor-body">

        <!-- LEFT PANEL: Question summary -->
        <div class="panel-questions">
            <div class="panel-questions-header">Estudio aplicado - Resumen de preguntas</div>

            <!-- Intro text (paragraph icon) -->
            <div class="q-item" data-q="intro">
                <div class="q-item-header">
                    <span class="q-icon">
                        <!-- paragraph pilcrow icon -->
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 4v16"/><path d="M17 4v16"/><path d="M13 4H9a4 4 0 0 0 0 8h4"/></svg>
                    </span>
                    <span class="q-text truncated">Hola! Somos Kosmos by UNIMER, te invitamos a participar en una breve encuesta. Te...</span>
                    <span class="q-chevron">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                    </span>
                </div>
                <div class="q-item-body">
                    <p style="font-size:14px;color:var(--text-secondary);line-height:1.6;">
                        Hola! Somos Kosmos by UNIMER, te invitamos a participar en una breve encuesta sobre tus habitos de compra. Tu opinion es muy importante para nosotros. La encuesta tomara solo unos minutos.
                    </p>
                </div>
            </div>

            <!-- P1 - Radio / single choice (EXPANDED by default) -->
            <div class="q-item open" data-q="p1">
                <div class="q-item-header">
                    <span class="q-icon">
                        <!-- radio / single choice icon -->
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4" fill="currentColor" stroke="none"/></svg>
                    </span>
                    <span class="q-text">P1 - Del siguiente listado de supermercados y lugares para comprar productos de alacena: abarrotes, productos de cuidado personal y del hogar, frutas, verduras y carnes, digame por favor cuales conoce?</span>
                    <span class="q-chevron">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                    </span>
                </div>
                <div class="q-item-body">
                    <div class="q-option"><span class="q-option-radio"></span> Walmart</div>
                    <div class="q-option"><span class="q-option-radio"></span> Coto</div>
                    <div class="q-option"><span class="q-option-radio"></span> Disco</div>
                </div>
            </div>

            <!-- P2 - Checkbox / multiple choice -->
            <div class="q-item" data-q="p2">
                <div class="q-item-header">
                    <span class="q-icon">
                        <!-- checkbox icon -->
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><polyline points="9 11 12 14 22 4" stroke-width="2"/></svg>
                    </span>
                    <span class="q-text truncated">P2 - En cual de los siguientes lugares ha visitado y comprado en los ultimos 30 dias pr...</span>
                    <span class="q-chevron">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                    </span>
                </div>
                <div class="q-item-body">
                    <div class="q-option"><span class="q-option-check"></span> Walmart</div>
                    <div class="q-option"><span class="q-option-check"></span> Coto</div>
                    <div class="q-option"><span class="q-option-check"></span> Disco</div>
                    <div class="q-option"><span class="q-option-check"></span> Carrefour</div>
                </div>
            </div>

            <!-- P3 - Ranking / list -->
            <div class="q-item" data-q="p3">
                <div class="q-item-header">
                    <span class="q-icon">
                        <!-- list icon -->
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                    </span>
                    <span class="q-text truncated">P3 - En cual de estos lugares gasta al menos el 35% de su presupuesto o compra la m...</span>
                    <span class="q-chevron">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                    </span>
                </div>
                <div class="q-item-body">
                    <div class="q-option"><span class="q-option-radio"></span> Walmart</div>
                    <div class="q-option"><span class="q-option-radio"></span> Coto</div>
                    <div class="q-option"><span class="q-option-radio"></span> Disco</div>
                </div>
            </div>

            <!-- P4 - Open text / smiley -->
            <div class="q-item" data-q="p4">
                <div class="q-item-header">
                    <span class="q-icon">
                        <!-- smiley icon -->
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
                    </span>
                    <span class="q-text truncated">P4 - En promedio, cuanto gasta en sus compras de alacena: abarrotes, productos de c...</span>
                    <span class="q-chevron">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
                    </span>
                </div>
                <div class="q-item-body">
                    <p style="font-size:14px;color:var(--text-secondary);">Respuesta abierta numerica</p>
                </div>
            </div>
        </div>

        <!-- RIGHT PANEL: Rules -->
        <div class="panel-rules" id="rulesContainer">

            <!-- REGLA 1 -->
            <div class="rule-card" data-rule="1">
                <div class="rule-card-header">
                    <span class="rule-card-title">Regla 1</span>
                    <div class="rule-card-actions">
                        <button class="rule-icon-btn" title="Copiar regla" onclick="duplicateRule(this)">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                        </button>
                        <button class="rule-icon-btn" title="Eliminar regla" onclick="deleteRule(this)">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
                        </button>
                    </div>
                </div>
                <div class="rule-row">
                    <span class="rule-label">Tipo</span>
                    <div class="rule-field">
                        <select class="rule-select placeholder" onchange="onRuleTypeChange(this)">
                            <option value="" disabled selected>Seleccionar regla</option>
                            <option value="mostrar">Mostrar una pregunta segun una respuesta</option>
                            <option value="no-mostrar">No mostrar una pregunta segun dato sociodemografico</option>
                            <option value="mostrar-pregunta">Mostrar una pregunta segun una respuesta</option>
                            <option value="agrupar">Agrupar preguntas</option>
                            <option value="redireccionar">Redireccionar</option>
                            <option value="referencia">Referencia a respuesta</option>
                            <option value="referencia-no">Referencia a respuesta: opciones NO seleccionadas</option>
                        </select>
                    </div>
                </div>
                <div class="rule-fields-dynamic"></div>
            </div>

        </div>
    </div>

    <!-- ===== FOOTER BAR ===== -->
    <div class="footer-bar">
        <button class="footer-add-btn" onclick="addRule()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Agregar regla
        </button>
        <a href="04-Editor-Config.html" class="footer-save-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
            Guardar y continuar con Configuracion
        </a>
    </div>

    <!-- ===== JAVASCRIPT ===== -->
    <script>
        /* ---- Accordion toggle for question items ---- */
        document.querySelectorAll('.q-item-header').forEach(function(header) {
            header.addEventListener('click', function() {
                var item = this.closest('.q-item');
                item.classList.toggle('open');
            });
        });

        /* ---- Rule counter ---- */
        var ruleCounter = 1;

        /* ---- Field templates per rule type ---- */
        function getFieldsHTML(type) {
            switch (type) {
                case 'mostrar':
                    return '' +
                        '<div class="rule-row"><span class="rule-label">Pregunta</span><div class="rule-field"><select class="rule-select"><option value="" disabled selected>Seleccionar pregunta</option><option>P1 -</option><option>P2 -</option><option>P3 -</option><option>P4 -</option></select></div></div>' +
                        '<div class="rule-row"><span class="rule-label">Respuesta</span><div class="rule-field"><select class="rule-select"><option value="" disabled selected>Seleccionar respuesta</option><option>Respuesta A</option><option>Respuesta B</option><option>Respuesta C</option></select></div></div>' +
                        '<div class="rule-row"><span class="rule-label">No mostrar</span><div class="rule-field"><select class="rule-select"><option value="" disabled selected>Seleccionar pregunta</option><option>P1 -</option><option>P2 -</option><option>P3 -</option><option>P4 -</option></select></div></div>';
                case 'no-mostrar':
                    return '' +
                        '<div class="rule-row"><span class="rule-label">Dato</span><div class="rule-field"><select class="rule-select"><option value="" disabled selected>Seleccionar dato</option><option>Edad</option><option>Genero</option><option>Pais</option><option>Ciudad</option></select></div></div>' +
                        '<div class="rule-row"><span class="rule-label">Pais</span><div class="rule-field"><select class="rule-select"><option value="" disabled selected>Seleccionar pais</option><option>ARG - BR</option><option>MEX</option><option>COL</option></select></div></div>' +
                        '<div class="rule-row"><span class="rule-label">No mostrar</span><div class="rule-field"><select class="rule-select"><option value="" disabled selected>Seleccionar pregunta</option><option>P1 -</option><option>P2 - Seleccion simple</option><option>P3 -</option><option>P4 -</option></select></div></div>';
                case 'mostrar-pregunta':
                    return '' +
                        '<div class="rule-row"><span class="rule-label">Pregunta</span><div class="rule-field"><select class="rule-select"><option value="" disabled selected>Seleccionar pregunta</option><option>P1 -</option><option>P2 -</option><option>P3 -</option><option>P4 -</option></select></div></div>' +
                        '<div class="rule-row"><span class="rule-label">Respuesta</span><div class="rule-field"><select class="rule-select"><option value="" disabled selected>Seleccionar respuesta</option><option>Respuesta A</option><option>Respuesta B</option></select></div></div>' +
                        '<div class="rule-row"><span class="rule-label">Mostrar</span><div class="rule-field"><select class="rule-select"><option value="" disabled selected>Seleccionar pregunta</option><option>P1 -</option><option>P2 -</option><option>P3 -</option><option>P4 -</option></select></div></div>';
                case 'agrupar':
                    return '' +
                        '<div class="rule-row"><span class="rule-label">Grupo</span><div class="rule-field"><select class="rule-select"><option value="" disabled selected>Seleccionar grupo</option><option>P1 - P2</option><option>P2 - P3</option><option>P3 - P4</option></select></div></div>' +
                        '<div class="rule-row"><span class="rule-label">Orden de opciones</span><div class="rule-field"><select class="rule-select"><option value="" disabled selected>Seleccionar orden</option><option>Flipeo</option><option>Aleatorio</option><option>Fijo</option></select></div></div>';
                case 'redireccionar':
                    return '' +
                        '<div class="rule-row"><span class="rule-label">Pregunta o grupos</span><div class="rule-field"><select class="rule-select"><option value="" disabled selected>Seleccionar</option><option>P1 - P2</option><option>P2 - P3</option><option>P3 - P4</option></select></div></div>';
                case 'referencia':
                    return '' +
                        '<div class="rule-row"><span class="rule-label">Respuesta de pregunta</span><div class="rule-field"><select class="rule-select"><option value="" disabled selected>Seleccionar pregunta</option><option>P1 - Del siguiente listado de supermercados y lugares par...</option><option>P2 -</option><option>P3 -</option></select></div></div>' +
                        '<div class="rule-row"><span class="rule-label">Referencia en pregunta</span><div class="rule-field"><select class="rule-select"><option value="" disabled selected>Seleccionar pregunta</option><option>P2 - En cual de los siguientes lugares ha visitado y comp...</option><option>P3 -</option><option>P4 -</option></select></div></div>';
                case 'referencia-no':
                    return '' +
                        '<div class="rule-row"><span class="rule-label">Descarte de pregunta</span><div class="rule-field"><select class="rule-select"><option value="" disabled selected>Seleccionar pregunta</option><option>P1 - Del siguiente listado de supermercados y lugares par...</option><option>P2 -</option></select></div></div>' +
                        '<div class="rule-row"><span class="rule-label">Referencia en pregunta</span><div class="rule-field"><select class="rule-select"><option value="" disabled selected>Seleccionar pregunta</option><option>P2 - En cual de los siguientes lugares ha visitado y comp...</option><option>P3 -</option></select></div></div>';
                default:
                    return '';
            }
        }

        /* ---- Handle rule type change ---- */
        function onRuleTypeChange(selectEl) {
            selectEl.classList.remove('placeholder');
            var card = selectEl.closest('.rule-card');
            var dynamicContainer = card.querySelector('.rule-fields-dynamic');
            var type = selectEl.value;
            dynamicContainer.innerHTML = getFieldsHTML(type);
            dynamicContainer.classList.add('visible');
        }

        /* ---- Add new rule ---- */
        function addRule() {
            ruleCounter++;
            var container = document.getElementById('rulesContainer');
            var card = document.createElement('div');
            card.className = 'rule-card';
            card.setAttribute('data-rule', ruleCounter);
            card.innerHTML = '' +
                '<div class="rule-card-header">' +
                    '<span class="rule-card-title">Regla ' + ruleCounter + '</span>' +
                    '<div class="rule-card-actions">' +
                        '<button class="rule-icon-btn" title="Copiar regla" onclick="duplicateRule(this)">' +
                            '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>' +
                        '</button>' +
                        '<button class="rule-icon-btn" title="Eliminar regla" onclick="deleteRule(this)">' +
                            '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>' +
                        '</button>' +
                    '</div>' +
                '</div>' +
                '<div class="rule-row">' +
                    '<span class="rule-label">Tipo</span>' +
                    '<div class="rule-field">' +
                        '<select class="rule-select placeholder" onchange="onRuleTypeChange(this)">' +
                            '<option value="" disabled selected>Seleccionar regla</option>' +
                            '<option value="mostrar">Mostrar una pregunta segun una respuesta</option>' +
                            '<option value="no-mostrar">No mostrar una pregunta segun dato sociodemografico</option>' +
                            '<option value="mostrar-pregunta">Mostrar una pregunta segun una respuesta</option>' +
                            '<option value="agrupar">Agrupar preguntas</option>' +
                            '<option value="redireccionar">Redireccionar</option>' +
                            '<option value="referencia">Referencia a respuesta</option>' +
                            '<option value="referencia-no">Referencia a respuesta: opciones NO seleccionadas</option>' +
                        '</select>' +
                    '</div>' +
                '</div>' +
                '<div class="rule-fields-dynamic"></div>';
            container.appendChild(card);
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        /* ---- Delete rule ---- */
        function deleteRule(btn) {
            var card = btn.closest('.rule-card');
            var container = document.getElementById('rulesContainer');
            if (container.children.length <= 1) return; // keep at least one
            card.remove();
            renumberRules();
        }

        /* ---- Duplicate rule ---- */
        function duplicateRule(btn) {
            var card = btn.closest('.rule-card');
            var container = document.getElementById('rulesContainer');
            ruleCounter++;
            var clone = card.cloneNode(true);
            clone.setAttribute('data-rule', ruleCounter);
            clone.querySelector('.rule-card-title').textContent = 'Regla ' + ruleCounter;
            container.insertBefore(clone, card.nextSibling);
            renumberRules();
            clone.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        /* ---- Renumber all rules sequentially ---- */
        function renumberRules() {
            var cards = document.querySelectorAll('#rulesContainer .rule-card');
            cards.forEach(function(card, index) {
                var num = index + 1;
                card.setAttribute('data-rule', num);
                card.querySelector('.rule-card-title').textContent = 'Regla ' + num;
            });
            ruleCounter = cards.length;
        }
    </script>

</body>
</html>
